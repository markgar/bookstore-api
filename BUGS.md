# Bugs

- [x] **BookService.Update is not thread-safe**: `Update` in `src/BookstoreApi/Services/BookService.cs` uses `ContainsKey` followed by a separate indexer assignment, which is a non-atomic check-then-act pattern. A concurrent `Delete` call between the `ContainsKey` check and the `_books[id] = book` assignment can cause the update to re-insert a just-deleted book. To reproduce: call `Update` and `Delete` for the same key concurrently in a tight loop; the book may reappear after deletion. Fix by using an atomic `ConcurrentDictionary` method such as `TryGetValue` paired with `TryUpdate`, or guard with a lock.
- [x] **IBookService not registered in DI container**: `Program.cs` does not register `IBookService`/`BookService` in the dependency injection container. The line `builder.Services.AddSingleton<IBookService, BookService>()` is missing. This causes every endpoint to return 500 Internal Server Error with `System.InvalidOperationException: Unable to resolve service for type 'BookstoreApi.Services.IBookService' while attempting to activate 'BookstoreApi.Controllers.BooksController'`. To reproduce: run the API with `dotnet run --project src/BookstoreApi` and send any request to `GET /api/books`.
- [ ] **Program class not accessible for integration testing**: `src/BookstoreApi/Program.cs` uses top-level statements, which causes the compiler to generate an internal `Program` class. Without adding `public partial class Program { }` at the bottom of the file, the test project cannot reference `Program` as a type argument to `WebApplicationFactory<Program>` from `Microsoft.AspNetCore.Mvc.Testing`. The test project already has `Microsoft.AspNetCore.Mvc.Testing` referenced and is set up to write integration tests, but any attempt to create `WebApplicationFactory<Program>` will fail with a compile error because `Program` is inaccessible. To reproduce: add a test class in `tests/BookstoreApi.Tests/` that references `WebApplicationFactory<Program>` and run `dotnet build` â€” it will fail with `CS0122: 'Program' is inaccessible due to its protection level`.
